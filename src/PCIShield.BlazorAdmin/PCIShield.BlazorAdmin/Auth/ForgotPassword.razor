@page "/Auth/ForgotPassword"
@using System.ComponentModel.DataAnnotations
@using Microsoft.AspNetCore.Components.Forms
@using MudBlazor
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject HttpClient HttpClient
@inject ILogger<ForgotPassword> Logger

<PageTitle>Forgot Password - PCIShield</PageTitle>

<MudGrid Justify="Justify.Center" AlignItems="AlignItems.Center" Style="height: 100vh; width:100vw; margin:0;">
    <MudItem xs="11" sm="8" md="6" lg="4" xl="3">
        <MudPaper Elevation="3" Class="pa-6">
            <div class="d-flex justify-center mb-4">
                <MudText Typo="Typo.h4">PCIShield ERP</MudText>
            </div>
            
            <MudText Typo="Typo.h6" Align="Align.Center" GutterBottom="true">
                Reset Your Password
            </MudText>
            
            <MudText Typo="Typo.body2" Align="Align.Center" Class="mb-4" Style="color: #666;">
                Enter your email address and we'll send you a link to reset your password.
            </MudText>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <MudAlert Severity="Severity.Error" Class="mb-3" Dense="true">
                    @_errorMessage
                </MudAlert>
            }

            @if (_emailSent)
            {
                <MudAlert Severity="Severity.Success" Class="mb-3" Dense="true">
                    <MudText Typo="Typo.body2">
                        If an account exists with this email address, you will receive a password reset link shortly.
                        Please check your inbox and spam folder.
                    </MudText>
                </MudAlert>
            }

            <MudForm @ref="_form" Model="_model" Validation="@(new DataAnnotationsValidator())">
                <MudTextField 
                    @bind-Value="_model.Email"
                    T="string"
                    Label="Email Address"
                    Variant="Variant.Outlined"
                    Margin="Margin.Dense"
                    Class="mt-3"
                    Required="true"
                    For="@(() => _model.Email)"
                    Disabled="_isSubmitting"
                    Immediate="true"
                    AutoFocus="true" />

                <MudButton 
                    OnClick="HandleSubmitAsync"
                    ButtonType="ButtonType.Submit"
                    Variant="Variant.Filled"
                    Color="Color.Primary"
                    Size="Size.Large"
                    FullWidth="true"
                    Class="mt-5 mb-3"
                    Disabled="_isSubmitting">
                    @if (_isSubmitting)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        <span>Sending...</span>
                    }
                    else
                    {
                        <span>Send Reset Link</span>
                    }
                </MudButton>
            </MudForm>

            <MudText Align="Align.Center" Class="mt-4">
                <MudLink Href="/Auth/Login">
                    <MudIcon Icon="@Icons.Material.Filled.ArrowBack" Size="Size.Small" Class="mr-1" />
                    Back to Login
                </MudLink>
            </MudText>

            @if (_emailSent)
            {
                <MudText Align="Align.Center" Class="mt-3" Typo="Typo.body2" Style="color: #666;">
                    Didn't receive the email?
                    <MudLink OnClick="HandleSubmitAsync" Disabled="_isSubmitting">
                        Resend
                    </MudLink>
                </MudText>
            }
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private MudForm? _form;
    private ForgotPasswordModel _model = new();
    private bool _isSubmitting;
    private bool _emailSent;
    private string? _errorMessage;

    private async Task HandleSubmitAsync()
    {
        _errorMessage = null;

        // Validate the form
        if (_form != null)
        {
            await _form.Validate();
            if (!_form.IsValid)
            {
                return;
            }
        }

        _isSubmitting = true;
        StateHasChanged();

        try
        {
            // Call the API endpoint
            var response = await HttpClient.PostAsJsonAsync(
                "https://localhost:52509/api/auth/v2/forgot-password",
                new { Email = _model.Email }
            );

            if (response.IsSuccessStatusCode)
            {
                _emailSent = true;
                Logger.LogInformation("Password reset email requested for {Email}", _model.Email);
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Logger.LogWarning("Forgot password request failed: {Error}", errorContent);
                _errorMessage = "An error occurred. Please try again later.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error submitting forgot password request");
            _errorMessage = "Unable to connect to the server. Please check your internet connection.";
        }
        finally
        {
            _isSubmitting = false;
            StateHasChanged();
        }
    }

    private sealed class ForgotPasswordModel
    {
        [Required(ErrorMessage = "Email is required")]
        [EmailAddress(ErrorMessage = "Please enter a valid email address")]
        public string Email { get; set; } = string.Empty;
    }
}