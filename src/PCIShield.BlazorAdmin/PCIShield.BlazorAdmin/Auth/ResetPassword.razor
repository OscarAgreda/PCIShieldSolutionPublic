@page "/Auth/ResetPassword"
@using System.ComponentModel.DataAnnotations
@using MudBlazor
@using Microsoft.AspNetCore.WebUtilities
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject HttpClient HttpClient
@inject ILogger<ResetPassword> Logger

<PageTitle>Reset Password - PCIShield</PageTitle>

<MudGrid Justify="Justify.Center" AlignItems="AlignItems.Center" Style="height: 100vh; width:100vw; margin:0;">
    <MudItem xs="11" sm="8" md="6" lg="4" xl="3">
        <MudPaper Elevation="3" Class="pa-6">
            <div class="d-flex justify-center mb-4">
                <MudText Typo="Typo.h4">PCIShield ERP</MudText>
            </div>
            
            <MudText Typo="Typo.h6" Align="Align.Center" GutterBottom="true">
                Create New Password
            </MudText>
            
            <MudText Typo="Typo.body2" Align="Align.Center" Class="mb-4" Style="color: #666;">
                Enter your new password below.
            </MudText>

            @if (!string.IsNullOrEmpty(_errorMessage))
            {
                <MudAlert Severity="Severity.Error" Class="mb-3" Dense="true">
                    @_errorMessage
                </MudAlert>
            }

            @if (_resetSuccessful)
            {
                <MudAlert Severity="Severity.Success" Class="mb-3" Dense="true">
                    <MudText Typo="Typo.body2" Class="mb-2">
                        Your password has been reset successfully!
                    </MudText>
                    <MudText Typo="Typo.body2">
                        You can now login with your new password.
                    </MudText>
                </MudAlert>
                
                <MudButton 
                    Href="/Auth/Login"
                    Variant="Variant.Filled"
                    Color="Color.Primary"
                    Size="Size.Large"
                    FullWidth="true"
                    Class="mt-4">
                    Go to Login
                </MudButton>
            }
            else if (_isTokenValid)
            {
                <MudForm @ref="_form" Model="_model">
                    <MudTextField 
                        @bind-Value="_model.Password"
                        T="string"
                        Label="New Password"
                        InputType="_passwordInputType"
                        Adornment="Adornment.End"
                        AdornmentIcon="_passwordInputIcon"
                        OnAdornmentClick="TogglePasswordVisibility"
                        Variant="Variant.Outlined"
                        Margin="Margin.Dense"
                        Class="mt-3"
                        Required="true"
                        For="@(() => _model.Password)"
                        Disabled="_isSubmitting"
                        HelperText="Must be at least 8 characters with uppercase, lowercase, number, and special character"
                        AutoFocus="true" />

                    <MudTextField 
                        @bind-Value="_model.ConfirmPassword"
                        T="string"
                        Label="Confirm Password"
                        InputType="_confirmPasswordInputType"
                        Adornment="Adornment.End"
                        AdornmentIcon="_confirmPasswordInputIcon"
                        OnAdornmentClick="ToggleConfirmPasswordVisibility"
                        Variant="Variant.Outlined"
                        Margin="Margin.Dense"
                        Class="mt-3"
                        Required="true"
                        For="@(() => _model.ConfirmPassword)"
                        Disabled="_isSubmitting" />

                    @if (!string.IsNullOrEmpty(_passwordError))
                    {
                        <MudText Typo="Typo.caption" Color="Color.Error" Class="mt-2">
                            @_passwordError
                        </MudText>
                    }

                    <MudButton 
                        OnClick="HandleSubmitAsync"
                        ButtonType="ButtonType.Submit"
                        Variant="Variant.Filled"
                        Color="Color.Primary"
                        Size="Size.Large"
                        FullWidth="true"
                        Class="mt-5 mb-3"
                        Disabled="_isSubmitting">
                        @if (_isSubmitting)
                        {
                            <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                            <span>Resetting...</span>
                        }
                        else
                        {
                            <span>Reset Password</span>
                        }
                    </MudButton>
                </MudForm>
            }
            else
            {
                <MudAlert Severity="Severity.Warning" Class="mb-3">
                    Invalid or expired reset link. Please request a new password reset.
                </MudAlert>
                
                <MudButton 
                    Href="/Auth/ForgotPassword"
                    Variant="Variant.Filled"
                    Color="Color.Primary"
                    Size="Size.Large"
                    FullWidth="true"
                    Class="mt-4">
                    Request New Reset Link
                </MudButton>
            }

            <MudText Align="Align.Center" Class="mt-4">
                <MudLink Href="/Auth/Login">
                    <MudIcon Icon="@Icons.Material.Filled.ArrowBack" Size="Size.Small" Class="mr-1" />
                    Back to Login
                </MudLink>
            </MudText>
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private MudForm? _form;
    private ResetPasswordModel _model = new();
    private bool _isSubmitting;
    private bool _resetSuccessful;
    private bool _isTokenValid;
    private string? _errorMessage;
    private string? _passwordError;
    private string? _email;
    private string? _token;

    private bool _passwordVisible;
    private InputType _passwordInputType = InputType.Password;
    private string _passwordInputIcon = Icons.Material.Filled.VisibilityOff;

    private bool _confirmPasswordVisible;
    private InputType _confirmPasswordInputType = InputType.Password;
    private string _confirmPasswordInputIcon = Icons.Material.Filled.VisibilityOff;

    protected override void OnInitialized()
    {
        // Parse query parameters
        var uri = NavigationManager.ToAbsoluteUri(NavigationManager.Uri);
        var queryParams = QueryHelpers.ParseQuery(uri.Query);

        if (queryParams.TryGetValue("email", out var emailValue))
        {
            _email = emailValue.ToString();
        }

        if (queryParams.TryGetValue("token", out var tokenValue))
        {
            _token = tokenValue.ToString();
        }

        // Validate that we have both email and token
        _isTokenValid = !string.IsNullOrEmpty(_email) && !string.IsNullOrEmpty(_token);

        if (!_isTokenValid)
        {
            Logger.LogWarning("Reset password page accessed without valid token or email");
        }
    }

    private void TogglePasswordVisibility()
    {
        _passwordVisible = !_passwordVisible;
        _passwordInputType = _passwordVisible ? InputType.Text : InputType.Password;
        _passwordInputIcon = _passwordVisible ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff;
    }

    private void ToggleConfirmPasswordVisibility()
    {
        _confirmPasswordVisible = !_confirmPasswordVisible;
        _confirmPasswordInputType = _confirmPasswordVisible ? InputType.Text : InputType.Password;
        _confirmPasswordInputIcon = _confirmPasswordVisible ? Icons.Material.Filled.Visibility : Icons.Material.Filled.VisibilityOff;
    }

    private async Task HandleSubmitAsync()
    {
        _errorMessage = null;
        _passwordError = null;

        // Client-side validation
        if (string.IsNullOrWhiteSpace(_model.Password))
        {
            _passwordError = "Password is required";
            return;
        }

        if (_model.Password.Length < 8)
        {
            _passwordError = "Password must be at least 8 characters";
            return;
        }

        if (_model.Password != _model.ConfirmPassword)
        {
            _passwordError = "Passwords do not match";
            return;
        }

        // Validate form
        if (_form != null)
        {
            await _form.Validate();
            if (!_form.IsValid)
            {
                return;
            }
        }

        _isSubmitting = true;
        StateHasChanged();

        try
        {
            var requestBody = new
            {
                Email = _email,
                Token = _token,
                Password = _model.Password,
                ConfirmPassword = _model.ConfirmPassword
            };

            var response = await HttpClient.PostAsJsonAsync(
                "https://localhost:52509/api/auth/v2/reset-password",
                requestBody
            );

            if (response.IsSuccessStatusCode)
            {
                _resetSuccessful = true;
                Logger.LogInformation("Password reset successful for {Email}", _email);
                Snackbar.Add("Password reset successfully!", Severity.Success);
            }
            else
            {
                var errorContent = await response.Content.ReadAsStringAsync();
                Logger.LogWarning("Password reset failed: {Error}", errorContent);
                _errorMessage = "Password reset failed. The link may have expired. Please request a new reset link.";
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error resetting password");
            _errorMessage = "An error occurred. Please try again later.";
        }
        finally
        {
            _isSubmitting = false;
            StateHasChanged();
        }
    }

    private sealed class ResetPasswordModel
    {
        [Required(ErrorMessage = "Password is required")]
        [StringLength(100, MinimumLength = 8, ErrorMessage = "Password must be between 8 and 100 characters")]
        public string Password { get; set; } = string.Empty;

        [Required(ErrorMessage = "Confirm password is required")]
        [Compare(nameof(Password), ErrorMessage = "Passwords do not match")]
        public string ConfirmPassword { get; set; } = string.Empty;
    }
}