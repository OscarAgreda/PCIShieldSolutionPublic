@using MudBlazor
@inject IStringLocalizer<CustomMudDialog> Localizer
<MudDialog class="container-dialog" ContentClass="content-dialog" ActionsClass="action-class">
    <TitleContent>
        <MudStack Spacing="2" AlignItems="AlignItems.Center">
            @if (ShowIcon && !string.IsNullOrEmpty(Icon))
            {
                <MudIcon Icon="@Icon" Class="icon-dialog" />
            }
            <MudText Class="title-dialog">@Title</MudText>
        </MudStack>
    </TitleContent>
    <DialogContent>
        @((MarkupString)ContentText)
        @if (ShowCountdown && !HasButtons)
        {
            <MudText Align="Align.Center" Class="mt-3 countdown-text">
                @($"Closing in {_remainingSeconds}s...")
            </MudText>
        }
    </DialogContent>
    <DialogActions>
        @if (HasButtons)
        {
            @foreach (var button in Buttons)
            {
                <MudButton OnClick="() => OnButtonClick(button.Key)"
                           Variant="@button.Value.Variant"
                           Class="@button.Value.Class">
                    @button.Value.Text
                </MudButton>
            }
        }
    </DialogActions>
</MudDialog>

@code {
    [CascadingParameter] IMudDialogInstance MudDialog { get; set; } = new MudDialogContainer();
    [Parameter] public string Title { get; set; } = String.Empty;
    [Parameter] public string ContentText { get; set; } = String.Empty;
    [Parameter] public string Icon { get; set; } = String.Empty;
    [Parameter] public bool ShowIcon { get; set; } = false;
    [Parameter] public bool HasButtons { get; set; } = true;
    [Parameter] public Dictionary<string, ButtonOptions> Buttons { get; set; } = new();
    [Parameter] public int AutoCloseDelay { get; set; } = 3000; 
    [Parameter] public bool ShowCountdown { get; set; } = true; 

    private int _remainingSeconds;
    private System.Threading.Timer? _countdownTimer;

    private void OnButtonClick(string buttonKey)
    {
        if (MudDialog != null)
            MudDialog.Close(DialogResult.Ok(buttonKey));
    }

    public class ButtonOptions
    {
        public string Text { get; set; } = String.Empty;
        public Variant Variant { get; set; } = Variant.Text;
        public string Class { get; set; } = String.Empty;
    }

    protected override void OnInitialized()
    {
        if (!HasButtons)
        {
            _remainingSeconds = AutoCloseDelay / 1000;

            // Initialize the countdown timer
            _countdownTimer = new System.Threading.Timer(async _ =>
            {
                _remainingSeconds--;
                await InvokeAsync(StateHasChanged);

                if (_remainingSeconds <= 0)
                {
                    _countdownTimer?.Dispose();

                    // Close the dialog when timer reaches zero
                    await InvokeAsync(() =>
                    {
                        if (MudDialog != null)
                            MudDialog.Close(DialogResult.Ok("AutoClose"));
                    });
                }
            }, null, 1000, 1000);

            // Set up auto-close
            _ = AutoCloseAfterDelay();
        }
    }

    private async Task AutoCloseAfterDelay()
    {
        await Task.Delay(AutoCloseDelay);

        // Make sure dialog wasn't already closed manually
        if (MudDialog != null && !HasButtons)
        {
            MudDialog.Close(DialogResult.Ok("AutoClose"));
        }
    }

    public void Dispose()
    {
        _countdownTimer?.Dispose();
    }
}